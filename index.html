<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Badminton Bar Scoreboard</title>
  <style>
    :root{
    --bg: #f6f4f1;
    --paper: rgba(255,255,255,.86);
    --paper2: rgba(255,255,255,.72);
    --stroke: rgba(20,30,45,.12);
    --stroke2: rgba(20,30,45,.18);
    --text: rgba(20,30,45,.92);
    --muted: rgba(20,30,45,.55);
    --accent: #c48a2c;
    --radius: 18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }

    body{
    font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC","Noto Sans TC","Microsoft JhengHei", sans-serif;
    color: var(--text);
    background: radial-gradient(1100px 700px at 15% 10%, rgba(255,255,255,.75), transparent 55%), var(--bg);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:16px;
    }

    .wrap{ width:min(1200px, 100%); }

    .board{
    border-radius: var(--radius);
    overflow:hidden;
    border: 1px solid var(--stroke);
    box-shadow: 0 18px 60px rgba(20,30,45,.12);
    background: linear-gradient(180deg, var(--paper), var(--paper2));
    backdrop-filter: blur(10px);
    }

    /* æ§åˆ¶é¢æ¿æ¯”ä¾‹ï¼šéšŠä¼ç¸®çŸ­ */
    .grid{
      display: grid;
      grid-template-columns: 1.2fr 1fr 1fr 1fr; 
      width: 100%;
    }

    .cell{
    padding: 18px;
    border-right:1px solid var(--stroke);
    border-bottom:1px solid var(--stroke);
    display:flex;
    align-items:center;
    justify-content:center;
    min-height: 80px;
    }
    .cell:last-child{ border-right:none; }

    .teamCell{ justify-content: space-between !important; padding-left: 15px; }

    .teamName{
    width: 100%;
    border: none;
    background: transparent;
    color: var(--text);
    outline:none;
    font-size: 24px;
    font-weight: 900;
    }

    .shuttle{ font-size: 32px; color: var(--accent); flex-shrink: 0; }

    .score{ font-variant-numeric: tabular-nums; font-weight: 950; font-size: 58px; line-height:1; }

    .dash{ opacity:.3; }

    .titleBar{ background: rgba(255,255,255,.70); padding: 14px; text-align: center; border-bottom: 1px solid var(--stroke); }
    .titleInput{ width:100%; text-align:center; font-weight: 950; font-size: 26px; background: transparent; border: none; outline:none; }

    /* å¹³æ¿æ§åˆ¶é¢æ¿ */
    .panel{
    margin-top: 20px;
    border-radius: 16px;
    padding: 16px;
    background: rgba(255,255,255,.9);
    display:flex;
    flex-direction: column;
    gap: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    }

    .tools-row{ display:flex; justify-content: center; gap: 12px; flex-wrap: wrap; align-items: center; }

    select, button { border-radius: 12px; border: 1px solid var(--stroke); background: white; padding: 12px 18px; font-weight: 800; font-size: 16px; cursor: pointer; outline: none; }
    
    /* å¤§æŒ‰éˆ• */
    .btn-score { min-width: 90px; padding: 20px 0; font-size: 24px; }
    button:active { background: #eee; }
    button.danger { color: #d9534f; border-color: #d9534f; }
    .pill { font-size: 14px; padding: 10px 15px; border: 1px solid var(--stroke); border-radius: 999px; background: white; }

    /* ===== ç›´æ’­é¡¯ç¤ºæ¨£å¼ (çµ•å°ä¸å‹•) ===== */
    body.displayOnly { padding: 0 !important; background: transparent !important; align-items: flex-start !important; }
    body.displayOnly .panel { display: none !important; }
    body.displayOnly .board { width: 100vw !important; border-radius: 0 !important; opacity: 0.8; border: 0 !important; box-shadow: none !important; }
    body.displayOnly .grid { grid-template-columns: repeat(4, 25vw) !important; } /* YouTube 25vw æ¯”ä¾‹ */
    body.displayOnly .cell { min-height: unset !important; padding: 10px; border-color: rgba(255,255,255,.3) !important; }
    body.displayOnly .score { font-size: clamp(28px, 6vw, 58px); }
    body.displayOnly .teamName { font-size: clamp(18px, 3vw, 26px); pointer-events: none; }
    
    .teamRowA{ background: linear-gradient(90deg, rgba(247,183,196,.55), rgba(255,255,255,.96)) !important; }
    .teamRowB{ background: linear-gradient(90deg, rgba(247,230,170,.60), rgba(255,255,255,.96)) !important; }

  </style>
</head>
<body>
<div class="wrap">
  <div class="board">
    <div class="titleBar">
      <input id="title" class="titleInput" value="è€é¼ æœƒç¾½çƒè³½" />
    </div>
    <div class="grid">
      <div class="cell teamCell teamRowA">
        <div class="teamLeft"><input id="nameA" class="teamName" value="éšŠä¼ A" /></div>
        <div class="shuttle" id="shuttleA">ğŸ¸</div>
      </div>
      <div class="cell scoreCell"><div class="score" id="A1">-</div></div>
      <div class="cell scoreCell"><div class="score" id="A2">-</div></div>
      <div class="cell scoreCell"><div class="score" id="A3">-</div></div>

      <div class="cell teamCell teamRowB">
        <div class="teamLeft"><input id="nameB" class="teamName" value="éšŠä¼ B" /></div>
        <div class="shuttle" id="shuttleB" style="opacity:0;">ğŸ¸</div>
      </div>
      <div class="cell scoreCell"><div class="score" id="B1">-</div></div>
      <div class="cell scoreCell"><div class="score" id="B2">-</div></div>
      <div class="cell scoreCell"><div class="score" id="B3">-</div></div>
    </div>
  </div>

  <div class="panel" id="panel">
    <div class="tools-row">
      <span class="pill">ID: <b id="matchPill">default</b></span>
      <label class="pill">ç›®å‰å±€ï¼š
        <select id="currentSet">
          <option value="1">ç¬¬ 1 å±€</option>
          <option value="2">ç¬¬ 2 å±€</option>
          <option value="3">ç¬¬ 3 å±€</option>
        </select>
      </label>
    </div>
    <div class="tools-row">
      <button id="Aplus" class="btn-score">A +1</button>
      <button id="Aminus" class="btn-score">A -1</button>
      <button id="Bplus" class="btn-score">B +1</button>
      <button id="Bminus" class="btn-score">B -1</button>
    </div>
    <div class="tools-row">
      <button id="clearCell">æ¸…ç©ºæœ¬å±€</button>
      <button id="resetAll" class="danger">é‡ç½®å…¨éƒ¨</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
  
  const firebaseConfig = {
    apiKey: "AIzaSyA4nfnsIBGLua60tZDVpWoKQKlY1BDjuvU",
    authDomain: "badminton-scoreboard-898a5.firebaseapp.com",
    databaseURL: "https://badminton-scoreboard-898a5-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "badminton-scoreboard-898a5",
    storageBucket: "badminton-scoreboard-898a5.firebasestorage.app",
    messagingSenderId: "1049093037710",
    appId: "1:1049093037710:web:b2f33852920a4892eef3df",
    measurementId: "G-HFQG0FBYH6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const qs = new URLSearchParams(location.search);
  const matchId = (qs.get('match') || 'default').trim();
  const displayOnly = (qs.get('view') === 'display');
  const roomRef = ref(db, `matches/${matchId}`);
  const el = (id) => document.getElementById(id);

  if (displayOnly) document.body.classList.add('displayOnly');
  el('matchPill').textContent = matchId;

  const defaultState = () => ({
    title: 'è€é¼ æœƒç¾½çƒè³½',
    nameA: 'éšŠä¼ A',
    nameB: 'éšŠä¼ B',
    scores: { A: {1:null,2:null,3:null}, B: {1:null,2:null,3:null} },
    serveTeamBySet: { 1: null, 2: null, 3: null },
    currentSet: 1,
    updatedAt: Date.now(),
  });

  let state = defaultState();

  onValue(roomRef, (snap) => {
    const remote = snap.val();
    if (remote) {
      if (!state.updatedAt || remote.updatedAt >= state.updatedAt) {
        state = remote;
        render();
      }
    }
  });

  async function save(){
    state.updatedAt = Date.now();
    await set(roomRef, state);
  }

  function fmt(v){ 
    if (v === null || v === undefined || v === '' || isNaN(v)) return '-';
    return String(v); 
  }

  function render(){
    el('title').value = state.title || '';
    el('nameA').value = state.nameA || '';
    el('nameB').value = state.nameB || '';
    el('currentSet').value = String(state.currentSet || 1);

    ['A','B'].forEach(t => {
      for(let s=1; s<=3; s++) {
        const val = (state.scores && state.scores[t]) ? state.scores[t][s] : null;
        const dom = el(t + s);
        if (dom) {
          dom.textContent = fmt(val);
          dom.classList.toggle('dash', fmt(val) === '-');
        }
      }
    });

    const curS = state.currentSet || 1;
    const serve = state.serveTeamBySet ? state.serveTeamBySet[curS] : null;
    el('shuttleA').style.opacity = (serve === 'A') ? 1 : 0;
    el('shuttleB').style.opacity = (serve === 'B') ? 1 : 0;
  }

  function inc(team, delta){
    const s = Number(el('currentSet').value);
    
    // ç‰©ä»¶å®‰å…¨æª¢æŸ¥
    if (!state.scores) state.scores = { A: {}, B: {} };
    if (!state.scores.A) state.scores.A = {};
    if (!state.scores.B) state.scores.B = {};

    let cur = state.scores[team][s];
    if (cur === null || cur === undefined || isNaN(cur) || cur === '') {
      cur = 0;
    }

    const next = cur + delta; // å…è¨±è² åˆ†
    state.scores[team][s] = next;

    if (delta > 0) {
      if (!state.serveTeamBySet) state.serveTeamBySet = {};
      state.serveTeamBySet[s] = team;
    }

    // 21åˆ†è‡ªå‹•è·³å±€ (åƒ…é™åŠ åˆ†æ™‚)
    if (next >= 21 && s < 4 && delta > 0) {
      state.currentSet = s + 1;
    }
    
    save(); 
    render();
  }

  if(!displayOnly){
    el('Aplus').onclick = () => inc('A', 1);
    el('Aminus').onclick = () => inc('A', -1);
    el('Bplus').onclick = () => inc('B', 1);
    el('Bminus').onclick = () => inc('B', -1);
    el('title').oninput = (e) => { state.title = e.target.value; save(); };
    el('nameA').oninput = (e) => { state.nameA = e.target.value; save(); };
    el('nameB').oninput = (e) => { state.nameB = e.target.value; save(); };
    el('currentSet').onchange = (e) => { state.currentSet = Number(e.target.value); save(); };
    el('clearCell').onclick = () => {
      const s = state.currentSet;
      if(state.scores && state.scores.A) state.scores.A[s] = null;
      if(state.scores && state.scores.B) state.scores.B[s] = null;
      save(); render();
    };
    el('resetAll').onclick = () => { if(confirm('é‡ç½®å…¨éƒ¨ï¼Ÿ')) { state = defaultState(); save(); render(); } };
  }
</script>
</body>
</html>