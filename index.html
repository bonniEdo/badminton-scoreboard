<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Badminton Bar Scoreboard</title>
  <style>
    :root{
    /* ===== Base (light, editorial) ===== */
    --bg: #f6f4f1;
    --paper: rgba(255,255,255,.86);
    --paper2: rgba(255,255,255,.72);
    --stroke: rgba(20,30,45,.12);
    --stroke2: rgba(20,30,45,.18);

    --text: rgba(20,30,45,.92);
    --muted: rgba(20,30,45,.55);

    /* A/B accent (modern broadcast) */
    --a: #5fb3a2;      /* teal */
    --b: #9b8fbf;      /* muted violet */

    /* Score cells */
    --scoreBg1: rgba(241, 245, 250, .98);
    --scoreBg2: rgba(233, 240, 249, .98);

    /* Title / accents */
    --accent: #c48a2c; /* warm gold */
    --radius: 18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC","Noto Sans TC","Microsoft JhengHei", sans-serif;
    color: var(--text);
    background:
        radial-gradient(1100px 700px at 15% 10%, rgba(255,255,255,.75), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(255,255,255,.60), transparent 55%),
        radial-gradient(900px 700px at 50% 120%, rgba(255,255,255,.55), transparent 60%),
        var(--bg);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:16px;
    }

    .wrap{ width:min(1200px, 100%); }

    .board{
    border-radius: var(--radius);
    overflow:hidden;
    border: 1px solid var(--stroke);
    box-shadow: 0 18px 60px rgba(20,30,45,.12);
    background: linear-gradient(180deg, var(--paper), var(--paper2));
    backdrop-filter: blur(10px);
    }

    /* ===== Layout grid (2 rows x 4 cols) ===== */
    .grid{
    display:grid;
    grid-template-columns: .80fr repeat(3, .8fr);
    width:100%;
    }

    .cell{
    padding: 18px 18px;
    border-right:1px solid var(--stroke);
    border-bottom:1px solid var(--stroke);
    display:flex;
    align-items:center;
    justify-content:center;
    min-height: 76px;
    }
    .cell:last-child{ border-right:none; }

    /* ===== Team cells (left column) ===== */
    .teamCell{
    justify-content:space-between;
    gap:14px;
    background: rgba(255,255,255,.86);
    position: relative;
    }

    /* Modern A/B identity: subtle tint + left bar */
    .teamRowA{
      background: linear-gradient(
        90deg,
        rgba(247, 183, 196, 0.35),   /* ç²‰ç´…ä¸»è‰² */
        rgba(255, 255, 255, 0.95)
      );
    }
    .teamRowB{
      background: linear-gradient(
        90deg,
        rgba(247, 230, 170, 0.40),   /* éµé»ƒè‰²ä¸»è‰² */
        rgba(255, 255, 255, 0.95)
      );
    }

    /* ===== Display æ¨¡å¼ï¼šç›´æ’­è‡ªé©æ‡‰ ===== */
    body.displayOnly{
      padding: 0 !important;
    }

    body.displayOnly .wrap{
      width: fit-content;
      transform: scale(var(--scale, 1));
      transform-origin: top left;
    }

    /* è§£é–é«˜åº¦ */
    body.displayOnly .cell{
      min-height: unset !important;
      padding: 8px 10px;
    }

    /* å­—é«”è·Ÿè‘—ç¸® */
    body.displayOnly .teamName{
      font-size: clamp(18px, 3vw, 26px);
    }
    body.displayOnly .score{
      font-size: clamp(28px, 6vw, 58px);
    }

    /* ä¸åŒç•«é¢å¤§å°çš„ç¸®æ”¾ */
    @media (max-width: 900px){ body.displayOnly .wrap{ --scale: .85; } }
    @media (max-width: 700px){ body.displayOnly .wrap{ --scale: .7; } }
    @media (max-width: 500px){ body.displayOnly .wrap{ --scale: .55; } }


    .teamLeft{
    display:flex;
    align-items:center;
    gap:12px;
    min-width: 0;
    flex:1;
    }

    /* If you still have .teamTag in HTML, keep it visually quiet */
    .teamTag{
    font-weight: 850;
    letter-spacing:.08em;
    font-size: 28px;
    line-height:1;
    width:32px;
    color: rgba(20,30,45,.55);
    }

    /* ===== Team name: looks like text, still editable ===== */
    .teamName{
    flex:1;
    min-width: 0;
    width: auto;
    border: none;
    border-radius: 0;
    padding: 6px 8px 6px 12px;
    background: transparent;
    color: var(--text);
    outline:none;

    font-size: 30px;
    font-weight: 900;
    letter-spacing: .4px;
    }
    .teamName::placeholder{
    color: rgba(20,30,45,.35);
    }
    .teamName:focus{
    border-bottom: 2px solid rgba(20,30,45,.18);
    }

    /* ===== Shuttle icon (serve indicator) ===== */
    .shuttle{
    font-size: 22px;
    color: var(--accent);
    opacity:.95;
    user-select:none;
    filter: drop-shadow(0 6px 14px rgba(196,138,44,.18));
    }

    /* ===== Score cells (right 3 columns) ===== */
    .scoreCell{
    background: linear-gradient(180deg, var(--scoreBg1), var(--scoreBg2));
    }

    .score{
    font-variant-numeric: tabular-nums;
    font-weight: 950;
    font-size: 58px;
    letter-spacing: -1px;
    line-height:1;
    color: var(--text);
    }

    .dash{
    opacity:.45;
    font-weight: 900;
    }

    /* editable score cell cursor */
    .editable{ cursor: text; }

    /* ===== Title bar ===== */
    .titleBar{
    background: rgba(255,255,255,.70);
    padding: 14px 18px;
    display:flex;
    align-items:center;
    justify-content:center;
    border-top: 1px solid var(--stroke);
    }

    .titleInput{
    width:100%;
    max-width: 900px;
    text-align:center;
    font-weight: 950;
    font-size: 26px;
    letter-spacing: 1px;
    color: var(--text);
    background: rgba(255,255,255,.55);
    border: 1px solid transparent;
    border-radius: 999px;
    padding: 10px 14px;
    outline:none;
    }
    .titleInput:focus{
    border-color: var(--stroke2);
    background: rgba(255,255,255,.82);
    }

    /* If you moved title to the top, add this class on the titleBar */
    .topTitle{
    border-bottom: 1px solid var(--stroke);
    border-top: none;
    }

    /* ===== Control panel ===== */
    .panel{
    margin-top: 14px;
    border: 1px solid var(--stroke);
    border-radius: 16px;
    padding: 12px;
    background: rgba(255,255,255,.70);
    box-shadow: 0 10px 30px rgba(20,30,45,.08);
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    }

    .leftTools, .rightTools{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
    }

    select, button, input.small{
    border-radius: 12px;
    border: 1px solid var(--stroke);
    background: rgba(255,255,255,.86);
    color: var(--text);
    padding: 10px 12px;
    font-weight: 800;
    font-size: 14px;
    outline:none;
    }
    button{ cursor:pointer; }
    button:hover{ background: rgba(255,255,255,.98); }

    button.danger{
    background: rgba(255,90,90,.10);
    border-color: rgba(255,90,90,.22);
    }
    button.danger:hover{ background: rgba(255,90,90,.14); }

    .pill{
    font-size:12px;
    color: var(--muted);
    padding: 8px 10px;
    border: 1px solid var(--stroke);
    border-radius: 999px;
    background: rgba(255,255,255,.75);
    }
    .pill b{ color: var(--text); }

    /* ===== Display-only mode (OBS / YouTube embed) ===== */
    .displayOnly .panel{ display:none; }
    .displayOnly .teamName,
    .displayOnly .titleInput{ pointer-events:none; }

    /* ===== Mobile ===== */
    @media (max-width: 720px){
    .cell{ min-height: 64px; padding: 14px; }
    .score{ font-size: 44px; }
    .teamTag{ font-size: 24px; width:26px; }
    .teamName{ font-size: 26px; }
    .titleInput{ font-size: 20px; }
    }
    .displayOnly .panel,
    .displayOnly .controls,
    .displayOnly .centerBtns,
    .displayOnly button {
     display: none !important;
    }
    /* ===== Display æ¨¡å¼ï¼šæ»¿ç‰ˆåªé¡¯ç¤ºè¨ˆåˆ†æ¡† ===== */
    body.displayOnly{
      padding: 0 !important;
      margin: 0 !important;
      background: transparent !important;   /* å¦‚æœä½ æƒ³è¦é€æ˜ç–Šåœ¨ç•«é¢ä¸Š */
      align-items: stretch !important;
      justify-content: stretch !important;
    }

    body.displayOnly .wrap{
      width: 100vw !important;
    }

    body.displayOnly .board{
      width: 100vw !important;
      max-width: none !important;
      border-radius: 0 !important;
      border: 0 !important;
      box-shadow: none !important;
      background: transparent !important;   /* åªå‰©å…§å®¹ï¼Œä¸è¦å¡ç‰‡åº• */
    }

    /* è®“æ ¼å­é‚Šç·šä¹Ÿæ›´åƒ overlayï¼ˆå¯é¸ï¼‰ */
    body.displayOnly .cell{
      border-color: rgba(255,255,255,.35) !important; /* å¦‚æœä½ åº•æ˜¯é€æ˜ã€ç–Šåœ¨æ·±è‰²ç•«é¢ä¸Š */
    }
       
  </style>
</head>
<body>
<div class="wrap">
  <div class="board" id="board">
    <div class="titleBar topTitle">
    <input id="title" class="titleInput" value="è€é¼ æœƒç¾½çƒè³½" />
    </div>
    <div class="grid">
      <!-- Row A -->
      <div class="cell teamCell teamRowA">
        <div class="teamLeft">
          <input id="nameA" class="teamName" value="éšŠä¼ A" />
        </div>
        <div class="shuttle" id="shuttleA" title="ç™¼çƒ">ğŸ¸</div>
      </div>
      <div class="cell scoreCell editable" data-team="A" data-set="1" title="é»ä¸€ä¸‹å¯è¼¸å…¥ï¼ˆå¯è² åˆ†ï¼Œç•™ç©ºé¡¯ç¤º -ï¼‰"><div class="score" id="A1">-</div></div>
      <div class="cell scoreCell editable" data-team="A" data-set="2" title="é»ä¸€ä¸‹å¯è¼¸å…¥ï¼ˆå¯è² åˆ†ï¼Œç•™ç©ºé¡¯ç¤º -ï¼‰"><div class="score" id="A2">-</div></div>
      <div class="cell scoreCell editable" data-team="A" data-set="3" title="é»ä¸€ä¸‹å¯è¼¸å…¥ï¼ˆå¯è² åˆ†ï¼Œç•™ç©ºé¡¯ç¤º -ï¼‰"><div class="score" id="A3">-</div></div>

      <!-- Row B -->
      <div class="cell teamCell teamRowB">
        <div class="teamLeft">
          <input id="nameB" class="teamName" value="éšŠä¼ B" />
        </div>
        <div class="shuttle" id="shuttleB" title="ç™¼çƒ" style="opacity:0;">ğŸ¸</div>
      </div>
      <div class="cell scoreCell editable" data-team="B" data-set="1" title="é»ä¸€ä¸‹å¯è¼¸å…¥ï¼ˆå¯è² åˆ†ï¼Œç•™ç©ºé¡¯ç¤º -ï¼‰"><div class="score" id="B1">-</div></div>
      <div class="cell scoreCell editable" data-team="B" data-set="2" title="é»ä¸€ä¸‹å¯è¼¸å…¥ï¼ˆå¯è² åˆ†ï¼Œç•™ç©ºé¡¯ç¤º -ï¼‰"><div class="score" id="B2">-</div></div>
      <div class="cell scoreCell editable" data-team="B" data-set="3" title="é»ä¸€ä¸‹å¯è¼¸å…¥ï¼ˆå¯è² åˆ†ï¼Œç•™ç©ºé¡¯ç¤º -ï¼‰"><div class="score" id="B3">-</div></div>
    </div>
  </div>

  <div class="panel" id="panel">
    <div class="leftTools">
      <span class="pill">æ¯”è³½IDï¼š<b id="matchPill">default</b></span>
      <span class="pill">æ¨¡å¼ï¼š<b id="modePill">control</b></span>
      <label class="pill">ç›®å‰å±€ï¼š
        <select id="currentSet">
          <option value="1">ç¬¬ 1 å±€</option>
          <option value="2">ç¬¬ 2 å±€</option>
          <option value="3">ç¬¬ 3 å±€</option>
        </select>
      </label>
    </div>

    <div class="rightTools">
      <button id="Aplus">A +1</button>
      <button id="Aminus">A -1</button>
      <button id="Bplus">B +1</button>
      <button id="Bminus">B -1</button>
      <button id="clearCell">æ¸…ç©ºç›®å‰å±€ï¼ˆè®Š -ï¼‰</button>
      <button id="resetAll" class="danger">é‡ç½®å…¨éƒ¨</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
  const firebaseConfig = {
    apiKey: "AIzaSyA4nfnsIBGLua60tZDVpWoKQKlY1BDjuvU",
    authDomain: "badminton-scoreboard-898a5.firebaseapp.com",
    databaseURL: "https://badminton-scoreboard-898a5-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "badminton-scoreboard-898a5",
    storageBucket: "badminton-scoreboard-898a5.firebasestorage.app",
    messagingSenderId: "1049093037710",
    appId: "1:1049093037710:web:b2f33852920a4892eef3df",
    measurementId: "G-HFQG0FBYH6"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const qs = new URLSearchParams(location.search);
  const matchId = (qs.get('match') || 'default').trim();
  const view = (qs.get('view') || 'control').trim().toLowerCase();
  const displayOnly = (view === 'display');

  const STORAGE_KEY = `badminton-bar:${matchId}`;
  const ROOM_KEY = `matches/${matchId}`;     // Firebase è·¯å¾‘
  const roomRef = ref(db, ROOM_KEY);

  const el = (id) => document.getElementById(id);

  const board = el('board');
  const panel = el('panel');
  if (displayOnly) document.body.classList.add('displayOnly');
  el('matchPill').textContent = matchId;
  el('modePill').textContent = displayOnly ? 'display' : 'control';

  const defaultState = () => ({
    title: 'è€é¼ æœƒç¾½çƒè³½',
    nameA: 'éšŠä¼ A',
    nameB: 'éšŠä¼ B',
    scores: { A: {1:null,2:null,3:null}, B: {1:null,2:null,3:null} },
    serveTeamBySet: { 1: null, 2: null, 3: null }, // 'A' or 'B'
    currentSet: 1,
    updatedAt: Date.now(),
  });

  let state = load();
    // âœ… Firebase å³æ™‚è¨‚é–±ï¼šåªè¨»å†Šä¸€æ¬¡ï¼ˆä¸è¦æ”¾åœ¨ render è£¡ï¼‰
  onValue(roomRef, (snap) => {
    const remote = snap.val();
    if (!remote) return;

    // é ç«¯æ¯”è¼ƒæ–°æ‰å¥—ç”¨ï¼ˆé¿å…æŠŠè‡ªå·±å‰›æ”¹çš„è“‹å›å»ï¼‰
    if (!state.updatedAt || (remote.updatedAt && remote.updatedAt >= state.updatedAt)) {
      state = { ...defaultState(), ...remote };
      render();
    }
  });


  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaultState();
      const s = JSON.parse(raw);
      return { ...defaultState(), ...s };
    }catch{
      return defaultState();
    }
  }

  async function save(){
    state.updatedAt = Date.now();

    // æœ¬æ©Ÿå‚™æ´
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));

    // é›²ç«¯åŒæ­¥ï¼ˆå¤±æ•—ä¹Ÿæ²’é—œä¿‚ï¼‰
    try{
      await set(roomRef, state);
    }catch(err){
      console.warn("Firebase save failed:", err);
    }
  }

  function fmt(v){
    return (v === null || v === undefined || v === '') ? '-' : String(v);
  }

  function render(){
    el('title').value = state.title;
    el('nameA').value = state.nameA;
    el('nameB').value = state.nameB;
    el('currentSet').value = String(state.currentSet);

    for (const team of ['A','B']){
      for (const set of [1,2,3]){
        const id = `${team}${set}`;
        const v = state.scores?.[team]?.[set];
        el(id).textContent = fmt(v);
        el(id).classList.toggle('dash', v === null || v === undefined || v === '');
      }
    }
    // ===== æ–°å¢ï¼šä¾æ“šç™¼çƒéšŠé¡¯ç¤ºç¾½çƒï¼ˆå¹³æ‰‹ä¹Ÿç…§é¡¯ç¤ºï¼‰=====
    const set = Number(state.currentSet);
    const serve = state.serveTeamBySet?.[set]; // 'A' | 'B' | null
    const shuttleA = document.getElementById('shuttleA');
    const shuttleB = document.getElementById('shuttleB');

    shuttleA.style.opacity = (serve === 'A') ? 1 : 0;
    shuttleB.style.opacity = (serve === 'B') ? 1 : 0;


  }

  function setScore(team, set, value){
    if(!state.scores[team]) state.scores[team] = {1:null,2:null,3:null};
    state.scores[team][set] = value;
    save(); render();
  }

  function getScore(team, set){
    const v = state.scores?.[team]?.[set];
    return (v === null || v === undefined || v === '') ? null : Number(v);
  }

  function inc(team, delta){
  const set = Number(el('currentSet').value);
  const current = getScore(team, set);
  const next = (current === null) ? delta : (current + delta);

  setScore(team, set, next);

  // âœ… å¾—åˆ†å°±æ›´æ–°ç™¼çƒéšŠï¼ˆåªåœ¨åŠ åˆ†æ™‚ï¼‰
  if (delta > 0) {
    state.serveTeamBySet[set] = team; // 'A' or 'B'
    save();
    render();
  }

  // âœ… 21 åˆ†è‡ªå‹•ä¸‹ä¸€å±€
  if (next >= 21 && set < 4) {
    state.currentSet = set + 1;
    el('currentSet').value = String(state.currentSet);
    save();
    render();
  }
}


  function clearCurrentSet(){
    const set = Number(el('currentSet').value);
    setScore('A', set, null);
    setScore('B', set, null);
  }

  function resetAll(){
    state = defaultState();
    save(); render();
  }

  // inputs
  el('title').addEventListener('input', () => { state.title = el('title').value; save(); });
  el('nameA').addEventListener('input', () => { state.nameA = el('nameA').value; save(); });
  el('nameB').addEventListener('input', () => { state.nameB = el('nameB').value; save(); });
  el('currentSet').addEventListener('change', () => { state.currentSet = Number(el('currentSet').value); save(); });

  // click to edit score cell (control mode only)
  if(!displayOnly){
    document.addEventListener('click', (e) => {
      const cell = e.target.closest('.editable');
      if(!cell) return;
      const team = cell.dataset.team;
      const set = Number(cell.dataset.set);

      const current = state.scores?.[team]?.[set];
      const input = prompt(`è¼¸å…¥ ${team} ç¬¬ ${set} å±€åˆ†æ•¸ï¼ˆå¯è² åˆ†ï¼›ç•™ç©º=é¡¯ç¤º -ï¼‰`, current === null ? '' : String(current));
      if (input === null) return; // cancel
      const trimmed = input.trim();
      if (trimmed === ''){
        setScore(team, set, null);
        return;
      }
      const n = Number(trimmed);
      if (!Number.isFinite(n) || !Number.isInteger(n)){
        alert('è«‹è¼¸å…¥æ•´æ•¸ï¼ˆä¾‹å¦‚ 21ã€0ã€-1ï¼‰æˆ–ç•™ç©ºã€‚');
        return;
      }
      setScore(team, set, n);
    });

    // control buttons
    el('Aplus').addEventListener('click', () => inc('A', +1));
    el('Aminus').addEventListener('click', () => inc('A', -1));
    el('Bplus').addEventListener('click', () => inc('B', +1));
    el('Bminus').addEventListener('click', () => inc('B', -1));
    el('clearCell').addEventListener('click', () => clearCurrentSet());
    el('resetAll').addEventListener('click', () => {
      if(confirm('ç¢ºå®šé‡ç½®å…¨éƒ¨ï¼ˆéšŠå/æ¨™é¡Œ/ä¸‰å±€åˆ†æ•¸ï¼‰ï¼Ÿ')) resetAll();
    });

    // hotkeys
    document.addEventListener('keydown', (e) => {
      if (e.target && (e.target.tagName === 'INPUT' || e.target.isContentEditable)) return;
      const k = e.key.toLowerCase();
      if(k === 'a') inc('A', +1);
      if(k === 'z') inc('A', -1);
      if(k === 'k') inc('B', +1);
      if(k === 'm') inc('B', -1);
      if(k === '1') { el('currentSet').value='1'; el('currentSet').dispatchEvent(new Event('change')); }
      if(k === '2') { el('currentSet').value='2'; el('currentSet').dispatchEvent(new Event('change')); }
      if(k === '3') { el('currentSet').value='3'; el('currentSet').dispatchEvent(new Event('change')); }
      if(k === 'c') clearCurrentSet();
      if(k === 'r') { if(confirm('ç¢ºå®šé‡ç½®å…¨éƒ¨ï¼Ÿ')) resetAll(); }
    });
  }

  // sync across tabs on same device
  window.addEventListener('storage', (e) => {
    if(e.key === STORAGE_KEY){
      state = load();
      render();
    }
  });

  render();
</script>
</body>
</html>
